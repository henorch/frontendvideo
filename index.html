<!DOCTYPE html>
<html>
<head>
  <title>V-chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    video { width: 300px; margin: 5px; background: black; }
  </style>
</head>
<body>

<button id="startCam">Start Camera</button>
<button id="shareScreen">Share Screen</button>

<div>
  <h3>Me</h3>
  <video id="localVideo" autoplay playsinline muted></video>
</div>

<div>
  <h3>Remote</h3>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<script>
const socket = io("https://videocall-900w.onrender.com");

const roomId = "classroom101";
socket.emit("join-room", roomId);

let localStream;
let pc;

// store all remote users
const peers = {};

// get camera first
document.getElementById("startCam").onclick = async () => {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  document.getElementById("localVideo").srcObject = localStream;

  setupPeerConnection();
};

function setupPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" } // important for deployed peers
    ]
  });

  // add local tracks
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // display remote streams
  pc.ontrack = (e) => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  // ICE candidates
  pc.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit("ice-candidate", { candidate: e.candidate });
    }
  };
}

// handle someone joining
socket.on("user-joined", async (id) => {
  console.log("User joined:", id);
  if (!pc) setupPeerConnection();

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("offer", { sdp: offer, to: id, from: socket.id });
});

// receive offer
socket.on("offer", async ({ sdp, from }) => {
  console.log("Received offer from:", from);
  if (!pc) setupPeerConnection();

  await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit("answer", { sdp: answer, to: from, from: socket.id });
});

// receive answer
socket.on("answer", async ({ sdp, from }) => {
  console.log("Received answer from:", from);
  await pc.setRemoteDescription(new RTCSessionDescription(sdp));
});

// ICE
socket.on("ice-candidate", async ({ candidate }) => {
  try {
    await pc.addIceCandidate(candidate);
  } catch (e) {
    console.error("Error adding ICE candidate", e);
  }
});

// SCREEN SHARE
document.getElementById("shareScreen").onclick = async () => {
  if (!localStream) {
    alert("Start camera first!");
    return;
  }

  const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  const screenTrack = screenStream.getVideoTracks()[0];

  const sender = pc.getSenders().find(s => s.track.kind === "video");
  sender.replaceTrack(screenTrack);

  screenTrack.onended = () => {
    const localVideoTrack = localStream.getVideoTracks()[0];
    sender.replaceTrack(localVideoTrack);
  };
};
</script>
</body>
</html>
